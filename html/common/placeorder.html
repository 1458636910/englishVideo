<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="../../css/vant.css" />
    <style>
        body {}

        #app {
          width: 100%;
          overflow: hidden;
            background: white;
            min-height: 100vh;
            /*padding-top: 3vw;*/
            box-sizing: border-box;
              padding: 3vw;
        }
        [v-cloak]{
          /*display: none;*/
        }
        .listsBox{
        }
        .shopName{
          color: #999999;
        }
        .shopimg{
          width: 20vw;
          height: 20vw;
          margin-right: 3vw;
        }
        .shopimg img{
          width: 100%;
          height: 100%;
          border-radius: 5px;
        }
        .list{
          display: flex;
          align-items: center;
          /*margin-bottom: 3vw;*/
          border-bottom: 1px solid #f5f5f5;
          padding: 3vw 0;
        }
        .nameBox{
          width: 70vw;
          height: 16vw;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        }
        .name{
          color: #403e3e;
          overflow: hidden;
          text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .price{
          display: flex;
          justify-content: space-between;
          color: #999999;
          font-size: 14px;
        }
        .price span:nth-child(1){
          color: #FA607D;
          font-size: 16px;
        }
        /**/
        .ship{
          display: flex;
          justify-content: space-between;
          padding: 3vw 0 3vw;
            color: #403e3e;
            padding-left: 0;
          border-bottom: 1px solid #f5f5f5;
        }
        .shiplist{
          padding: 3vw 0;
          display: flex;
          align-items: center;
          justify-content: space-between;
          border-bottom: 1px solid #f5f5f5;
        }
        .chose{
          width: 20px;
          height: 20px;
          border-radius: 50%;
          border: 1px solid #757575;
        }
        .shipl{
          flex: 1;
        }
        .tit{
          padding-bottom: 3vw;
            color: #403e3e;
        }
        .shipl p:nth-child(2){
          color: #999999;
        }
        .chose.active{
          border: 1px solid #e86a7f;
          background-image: url(../../image/chose.png);
          background-size: 100%;
        }
        .shipl span{
          color: #ff5d78;
          /*font-weight: 700;*/
        }
        /**/
        .notes{
          padding: 3vw 0;
          position: relative;
        }
        .notes p{
          margin-bottom: 3vw;
        }
        .notes textarea{
          width: 100%;
          height: 30vw;
          border: 1px solid #f5f5f5;
          resize: none;
          padding: 3vw;
          box-sizing: border-box;
          padding-bottom: 5vw;
          outline: none;
        }
        .notes span{
          position: absolute;
          right: 3vw;
          bottom: 5vw;
          font-size: 12px;
          color: #999999;
        }
        /**/
        .dress{
          color: #999999;
          border-bottom: 1px solid #f5f5f5;
        }
        .dress p:nth-child(1){
          color: #403e3e;
        }
        .dress p{
          margin-bottom: 3vw;
        }
        /**/
        .payth{
          border-bottom: 1px solid #f5f5f5;
          padding-bottom: 3vw;
        }
        .payth p{
          padding: 3vw 0;
        }
        .paypal{
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .paypal img{
          max-height: 20px;
        }
        /**/
        .coupons{
          padding: 3vw 0;
          display: flex;
          justify-content: space-between;
          border-bottom: 1px solid #f5f5f5;
        }
        .bomTotals div{
          display: flex;
          justify-content: space-between;
          padding: 3vw 0;
          color: #3a3939;
          border-bottom: 1px solid #f5f5f5;
        }
        .bomTotals div:last-child{
          color: black;
          border-bottom: 0;
        }
        .diamonlist{
          display: flex;
          justify-content: space-between;
          padding: 3vw 0;
        }
        .chose{
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: #f5f5f5;
        }
        .chose img{
          width: 100%;
          /*display: none;*/
        }
        .choseTerms{
          display: flex;
          align-items: center;
          justify-content: space-between;
          height: 12vw;
          border-bottom: 1px solid #f5f5f5;
        }
        .choseTerms span:nth-child(1){
          text-decoration: underline;
        }

    </style>
</head>

<body>
    <div id="app" v-cloak>
      <div class="dress" @click="dressList()">
        <div v-if="dressId">
          <p>Ship to</p>
          <p>{{dressCount}}</p>
          <p>{{dressPhone}}</p>
        </div>
        <p v-if="dressId == ''">Delivery Address</p>
      </div>

      <!-- éè´­ç‰©è½¦ -->
    <div v-if="type == 'buy'">
      <div class="listsBox">
        <div class="lists">
          <p class="shopName">{{business_name}}</p>
          <div class="list">
            <div class="shopimg">
              <img :src="product.thumb" alt="">
            </div>
            <div class="nameBox">
              <p class="name">{{product.title}}</p>
              <p class="price">
                <span>ï¿¡{{product.sale_price}}</span>
                <span>x{{buy_num}}</span>
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="ship" @click="choseship()">
        <span>Shipping</span>
        <div>
          <span>{{postage}}</span>
          <i class="iconfont">&#xe62d;</i>
        </div>
      </div>
      <div class="coupons" @click="addcoupon()">
        <span>Add coupons</span>
        <span>
          <span v-if="couponprice">-ï¿¡{{couponprice}}</span>
          <i class="iconfont">&#xe62d;</i>
        </span>
      </div>
      <div class="choseTerms" v-if="terms_status == 1">
        <span @click="goterms()">I agree Term & Conditions</span>
        <span class="chose" @click="agreeterms()">
        <!-- <span class="chose" :class="item.ischose?'showimg':''"> -->
          <img v-if="agree_status == 1" src="../../image/chose.png" alt="">
        </span>
      </div>
      <div class="notes">
        <p>Order Notes</p>
        <div class="textAre">
          <textarea v-model="notes" name="name"></textarea>
          <span>{{500-notes.length}} character(s) remaining</span>
        </div>
      </div>
    </div>
    <!-- è´­ç‰©è½¦ -->
    <div v-if="type == 'cart'">
      <div v-for="(item,index) in store_carts">
        <div class="listsBox">
          <div class="lists">
            <p class="shopName">{{item.business_name}}</p>
            <div class="list" v-for="(ite,ind) in item.carts">
              <div class="shopimg">
                <img :src="ite.thumb" alt="">
              </div>
              <div class="nameBox">
                <p class="name">{{ite.title}}</p>
                <p class="price">
                  <span>ï¿¡{{ite.sale_price}}</span>
                  <span>x{{ite.buy_num}}</span>
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="ship" @click="choseship(item,index)">
          <span>Shipping</span>

          <div>
            <span v-if="item.postage_type != 0">ï¿¡{{item.postage}}</span>
            <i class="iconfont">&#xe62d;</i>
          </div>
        </div>
        <div class="coupons" @click="addcoupon(item,index)">
          <span>Add coupons</span>
          <span>
            <span v-if="item.coupon_id != 0">
              <!-- Chosen -->
              -ï¿¡{{item.coupon_discount_money}}
            </span>
            <i class="iconfont">&#xe62d;</i>
          </span>
        </div>
        <div class="notes">
          <p>Order Notes</p>
          <div class="textAre">
            <textarea v-model="item.order_notes" name="name"></textarea>
            <span>{{500-item.order_notes.length}} character(s) remaining</span>
          </div>
        </div>
      </div>
    </div>
    <!-- <div class="diamon"> -->
    <div class="diamon" v-if="ishowDiamon">
      <p>Diamond deduction</p>
      <div class="diamonlist">
        <span>
          ğŸ’
          {{jewel_exchange_money}}
        </span>
        <div @click="checkDiamon()">
          <van-switch v-model="checked" active-color="#FA607D" inactive-color="#f5f5f5" size="24px" />
        </div>
      </div>
    </div>

      <div class="payth">
        <p>Pay with</p>
        <div class="paypal">
          <img src="../../image/Paypal.png" alt="">
          <div class="chose active"></div>
        </div>
      </div>
      <div class="bomTotals">
        <!-- <div>
          <span>Subtotal(1 item)</span>
          <span>$399.00</span>
        </div> -->
          <div v-if="type == 'cart'">
            <span>Shipping</span>
            <span>ï¿¡{{postage_total}}</span>
          </div>
            <div>
              <span>Order Total</span>
              <span>ï¿¡{{order_total}}</span>
            </div>
      </div>
    </div>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/fastclick.js"></script>
<script src="../../script/vue.min.js"></script>
<script src="../../script/vant.js"></script>
<script src="../../script/commonurl.js"></script>
<script type="text/javascript">
var app;
    apiready = function() {
        app = new Vue({
            el: '#app',
            data() {
                return {
                  shipactive:0,
                  notes:'',
                  couponid:'',
                  couponprice:'',
                  postage:'',
                  postage_type:'',//é‚®å¯„æ–¹å¼
                  dressId:'',
                  dressName:'',
                  dressPhone:'',
                  dressCount:'',
                  receiver_country:'',//æ”¶è´§äººæ‰€åœ¨å›½å®¶
                  //
                  type:'',
                  product_id:'',//éè´­ç‰©è½¦ä¸‹å•
                  store_id:'',
                  buy_num:0,//éè´­ç‰©è½¦è´­ä¹°æ•°é‡
                  old_sale_price:0,
                  live_id:'',
                  business_name:'',
                  product:{},
                  order_total:0,//è®¢å•æ€»ä»·
                  buyData:null,
                  terms:'',
                  agree_status:0,
                  terms_status:0,

                  cart_ids:'',//è´­ç‰©è½¦çš„id
                  store_carts:[],//è´­ç‰©è½¦è¯¦æƒ…
                  postage_total:0,
                  submitObj:null,
                  submitObj1:null,
                  store_carts1:[],//é€‰æ‹©åœ°å€åé‡æ–°èµ‹å€¼
                  checked:false,
                  ishowDiamon:false,
                  jewel_exchange_money:0,
                  allmoney:0,
                }
            },
            created() {
              //type
              this.type = api.pageParam.type
              if (api.pageParam.type == 'buy') {
                //éè´­ç‰©è½¦
                this.product_id = api.pageParam.product_id
                this.buy_num = api.pageParam.buy_num
                this.getBuyDetail()
              }else if (api.pageParam.type == 'cart') {
                //è´­ç‰©è½¦
                this.cart_ids = api.pageParam.cart_ids
                this.getCartDetail()
              }

            },
            methods: {
              agreeterms(){
                if (this.agree_status == 1) {
                  this.agree_status = 0
                }else {
                  this.agree_status = 1
                }
              },
              goterms(){
                var _this = this;
                api.openWin({
                    name: 'buyterms_win',
                    url: './buyterms_win.html',
                    pageParam: {
                        terms: _this.terms
                    }
                });

              },
              //è®¡ç®—æ€»ä»·
              jsAllmoney(){
                for (var i = 0; i < this.store_carts.length; i++) {
                  var obj = this.store_carts[i];
                  this.order_total = Number(obj.order_total) + Number(obj.postage) - Number(obj.coupon_discount_money)
                }
                if (this.submitObj.is_use_jewel == 1) {
                  //ä½¿ç”¨é’»çŸ³
                  this.order_total = this.order_total - this.submitObj.jewel_exchange_money
                }
                this.submitObj.order_total = this.order_total
              },
              checkDiamon(){
                if (this.checked) {
                  if (this.allmoney - this.jewel_exchange_money > 0) {
                    this.submitObj.is_use_jewel = 1
                    this.order_total = this.allmoney - this.jewel_exchange_money
                  }else {
                    this.submitObj.is_use_jewel = 0
                    this.checked = false
                  }

                }else {
                  this.submitObj.is_use_jewel = 0
                  this.order_total = this.allmoney
                }
                this.jsAllmoney()
              },
              orderPay(){
                if (this.type == 'buy') {
                  this.buyPayFn()
                }else if(this.type == 'cart'){
                  //è´­ç‰©è½¦
                  this.buyCartPayFn()
                }
              },
              buyCartPayFn(){
                var _this = this;
                _this.submitObj.store_carts = _this.store_carts;
                if (_this.checked) {
                  _this.submitObj.is_use_jewel = 1
                }else {
                  _this.submitObj.is_use_jewel = 0
                }
                var submitData = JSON.stringify(_this.submitObj);
                // alert(submitData)
                // return
                var data = {
                  order_data:submitData
                };
                pubshowloading()
                requstPost('order/store',data,function success(ret){
                  // console.log(JSON.stringify(ret))
                  if (ret.code == 0) {
                    console.log(ret.data.pay_url)
                    goPaypalUrl(ret.data.pay_url)
                    api.closeWin();
                  }
                },function fail(err){

                })
                // alert(JSON.stringify(this.store_carts))
              },
              buyPayFn(){
                if (this.terms_status == 1 && this.agree_status == 0) {
                  api.alert({
                      title: 'Please agree to terms and conditions',
                      msg: '',
                      buttons:['Sure']
                  });
                  return
                }
                var _this = this;
                _this.buyData.order_notes = _this.notes;
                if (_this.checked) {
                  _this.buyData.is_use_jewel = 1
                }else {
                  _this.buyData.is_use_jewel = 0
                }
                var submitData = JSON.stringify(_this.buyData);
                var data = {
                  order_data:submitData
                };
                console.log(submitData);
                // alert(submitData)
                pubshowloading()
                requstPost('order/store',data,function success(ret){
                  if (ret.code == 0) {
                    goPaypalUrl(ret.data.pay_url)
                    api.closeWin();
                  }else{
                    api.toast({
                        msg: ret.msg,
                        duration: 2000,
                        location: 'middle'
                    });

                  }
                },function fail(err){

                })
              },
              //è´­ç‰©è½¦è·å–è¯¦æƒ…
              getCartDetail(){
                var _this = this;
                var data = {
                  cart_ids:_this.cart_ids
                };
                requstPost('buy/cartDetail',data,function success(ret){
                  if (ret.code == 0) {
                    if (ret.data.can_use_jewel != 0) {
                      _this.ishowDiamon = true
                      _this.jewel_exchange_money = ret.data.jewel_exchange_money
                    }
                    _this.submitObj = ret.data
                    _this.submitObj1 = JSON.parse(JSON.stringify(ret.data))
                    _this.postage_total = ret.data.postage_total
                    _this.store_carts = ret.data.store_carts
                    _this.store_carts1 = JSON.parse(JSON.stringify(ret.data.store_carts))
                    // alert(ret.data.order_total)
                    _this.order_total = ret.data.order_total
                    _this.allmoney = ret.data.order_total
                    if (ret.data.address_id != 0) {
                      var getserdress = ret.data.address
                      _this.receiver_country = getserdress.country
                      _this.dressId = getserdress.id
                      _this.dressName = getserdress.receiver
                      _this.dressPhone = getserdress.cellphone_number
                      _this.dressCount = getserdress.country +' '+getserdress.province+' '+getserdress.city+' '+getserdress.address
                    }
                  }
                },function fail(err){

                })
              },
              //éè´­ç‰©è½¦è·å–è¯¦æƒ…
              getBuyDetail(){
                var _this = this;
                var data = {
                  product_id:_this.product_id,
                  buy_num:_this.buy_num,
                  live_id:_this.live_id,
                  address_id:_this.dressId
                };
                requstPost('buy/orderDetail',data,function success(ret){
                  if (ret.code == 0) {
                    _this.terms_status = ret.data.terms_status
                    _this.terms = ret.data.terms_content
                    _this.agree_status = ret.data.agree_status
                    if (ret.data.can_use_jewel != 0) {
                      _this.ishowDiamon = true
                      _this.jewel_exchange_money = ret.data.jewel_exchange_money
                    }
                    _this.buyData = ret.data;
                    _this.business_name = ret.data.store.business_name
                    _this.store_id = ret.data.store.id
                    _this.product = ret.data.product
                    if (ret.data.postage_type != 0) {
                      _this.postage = ret.data.postage
                      _this.postage_type = ret.data.postage_type
                    }
                    if (ret.data.coupon_id != 0) {
                      _this.couponid = ret.data.coupon_id
                      _this.couponprice = ret.data.coupon_id
                    }
                    _this.order_total = ret.data.order_total
                    _this.allmoney = ret.data.order_total
                    _this.old_sale_price = ret.data.old_sale_price
                    if (ret.data.address_id != 0) {
                      var getserdress = ret.data.address
                      _this.receiver_country = getserdress.country
                      _this.dressId = getserdress.id
                      _this.dressName = getserdress.receiver
                      _this.dressPhone = getserdress.cellphone_number
                      _this.dressCount = getserdress.country +' '+getserdress.province+' '+getserdress.city+' '+getserdress.address
                    }

                    // alert(JSON.stringify(ret))
                  }
                },function fail(err){

                })
              },
              //é€‰æ‹©åœ°å€
              dressList(){
                api.openWin({
                    name: 'dresslist_win',
                    url: '../user/dresslist_win.html',
                    pageParam: {
                        type: 'buy'
                    }
                });
              },
              //æ”¹å˜åœ°å€
              dressChange(id,name,phone,dress,country){
                this.dressId = id
                this.dressName = name
                this.dressPhone = phone
                this.dressCount = dress
                this.receiver_country = country
                if (this.type == 'buy') {
                  this.getBuyDetail()
                }else if(this.type == 'cart'){
                  // this.getCartDetail()
                    this.store_carts = this.store_carts1
                    this.submitObj = this.submitObj1
                    this.submitObj.address_id = id
                }
              },
              //é€‰æ‹©é‚®å¯„æ–¹å¼
              choseship(item,index){
                if (this.receiver_country == '') {
                  api.alert({
                      title: 'Please select a harvest address first',
                      msg: '',
                      buttons:["Sure"]
                  }, function(ret, err){
                      if( ret ){
                          //  alert( JSON.stringify( ret ) );
                      }else{
                          //  alert( JSON.stringify( err ) );
                      }
                  });

                  return
                }
                var _this = this;


                if (api.pageParam.type == 'buy') {
                  // alert(_this.store_id)
                  api.openWin({
                      name: 'placeship_win',
                      url: './placeship_win.html',
                      pageParam: {
                        type:'buy',
                          store_id: _this.store_id,//å•†å®¶id
                          receiver_country:_this.receiver_country,
                          buyer_consume_fee:_this.old_sale_price,//æ¶ˆè´¹é‡‘é¢
                          storeInd:0,//å½“å‰ç‚¹å‡»çš„å•†å®¶ä¸‹æ ‡ï¼Œä»¥ä¾¿äºé€‰æ‹©é‚®å¯„æ–¹å¼åæ›´æ–°ä¿¡æ¯
                      }
                  });
                  return
                }else {
                  api.openWin({
                      name: 'placeship_win',
                      url: './placeship_win.html',
                      pageParam: {
                        type:'cart',
                          store_id: item.store_id,//å•†å®¶id
                          receiver_country:_this.receiver_country,
                          buyer_consume_fee:item.order_total,//æ¶ˆè´¹é‡‘é¢
                          storeInd:index,//å½“å‰ç‚¹å‡»çš„å•†å®¶ä¸‹æ ‡ï¼Œä»¥ä¾¿äºé€‰æ‹©é‚®å¯„æ–¹å¼åæ›´æ–°ä¿¡æ¯
                      }
                  });
                  return

                }
                var money = 0;
                for (var i = 0; i < item.carts.length; i++) {
                   money += Number(item.carts[i].buy_num) * Number(item.carts[i].sale_price)
                }
                api.openWin({
                    name: 'placeship_win',
                    url: './placeship_win.html',
                    pageParam: {
                      type:'cart',
                        store_id: item.store_id,//å•†å®¶id
                        receiver_country:_this.receiver_country,
                        buyer_consume_fee:money,//æ¶ˆè´¹é‡‘é¢
                        storeInd:index,//å½“å‰ç‚¹å‡»çš„å•†å®¶ä¸‹æ ‡ï¼Œä»¥ä¾¿äºé€‰æ‹©é‚®å¯„æ–¹å¼åæ›´æ–°ä¿¡æ¯
                    }
                });
              },
              //æ¥æ”¶é€‰æ‹©çš„é‚®å¯„æ–¹å¼
              chengeShip(id,price,ind){
                if (this.type == 'buy') {
                  this.postage_type = id
                  this.postage = price
                  this.buyData.postage_type = id
                  this.buyData.postage = price
                  this.order_total = Number(this.allmoney) + Number(price)
                }else {
                  //è´­ç‰©è½¦
                  // this.lists[ind].shipType = id
                  this.store_carts[ind].postage_type = id
                  this.store_carts[ind].postage = price
                  this.order_total = Number(this.allmoney) + Number(price)
                  this.jsAllmoney()
                  // alert(id)
                  // alert(price)
                  // alert(ind)
                }

              },
              //æ¥æ”¶é€‰æ‹©çš„ä¼˜æƒ åˆ¸
              chengeCoupon(id,price,ind){
                //ind ä¸ºå½“å‰è¦æ·»åŠ ä¼˜æƒ åˆ¸çš„å•†å®¶ä¸‹æ ‡
                if (this.type == 'buy') {
                  this.couponid = id
                  this.couponprice = price
                  this.order_total = this.order_total - price
                  this.buyData.coupon_id = id
                }else {
                  //è´­ç‰©è½¦
                  this.store_carts[ind].coupon_id = id
                  this.store_carts[ind].coupon_discount_money = price
                  this.order_total -= price
                  this.jsAllmoney()
                  // this.store_carts[ind].coupon_id = id
                }

                console.log(id);
                console.log(price);
              },
              //å‰å¾€é€‰æ‹©ä¼˜æƒ åˆ¸
              addcoupon(item,index){
              var _this = this;
                if (_this.type == 'buy') {
                  api.openWin({
                      name: 'addcoupon_win',
                      url: './addcoupon_win.html',
                      pageParam: {
                        type:'buy',
                          store_id: _this.store_id,
                          storeInd:0,
                          product_ids:_this.product.id,
                          buyer_consume_fee:_this.old_sale_price,
                          // couponid:_this.couponid
                      }
                  });
                  return
                }else {
                  var productIdsArry = [];
                  for (var i = 0; i < item.carts.length; i++) {
                    productIdsArry.push(item.carts[i].product_id)
                  }
                  var productIds = productIdsArry.join(',');
                  api.openWin({
                      name: 'addcoupon_win',
                      url: './addcoupon_win.html',
                      pageParam: {
                        type:'cart',
                          store_id: item.store_id,
                          storeInd:index,
                          product_ids:productIds,
                          buyer_consume_fee:item.order_total,
                          // couponid:_this.couponid
                      }
                  });
                }
                return
                var product_idsAry = [];
                var product_ids;
                var buyer_consume_fee;
                for (var i = 0; i < item.carts.length; i++) {
                  product_idsAry.push(item.carts[i].product_id)
                  buyer_consume_fee += Number(item.carts[i].buy_num) * Number(item.carts[i].sale_price)
                }
                product_ids = product_idsAry.join(',')
                api.openWin({
                    name: 'addcoupon_win',
                    url: './addcoupon_win.html',
                    pageParam: {
                      type:'cart',
                        store_id: item.store_id,
                        storeInd:index,
                        product_ids:product_ids,
                        buyer_consume_fee:buyer_consume_fee,
                        // couponid:_this.couponid
                    }
                });

              },


            }
        })

    };
</script>

</html>
